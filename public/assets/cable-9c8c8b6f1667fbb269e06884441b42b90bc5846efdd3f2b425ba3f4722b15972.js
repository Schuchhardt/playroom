!function(t,n){"object"==typeof exports&&"undefined"!=typeof module?n(exports):"function"==typeof define&&define.amd?define(["exports"],n):n(t.ActionCable={})}(this,(function(t){"use strict";function n(t){if("function"==typeof t&&(t=t()),t&&!/^wss?:/i.test(t)){var n=document.createElement("a");return n.href=t,n.href=n.href,n.protocol=n.protocol.replace("http","ws"),n.href}return t}function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:o("url")||f.default_mount_path;return new C(t)}function o(t){var n=document.head.querySelector("meta[name='action-cable-"+t+"']");if(n)return n.getAttribute("content")}var i={logger:self.console,WebSocket:self.WebSocket},r={log:function(){if(this.enabled){for(var t,n=arguments.length,e=Array(n),o=0;o<n;o++)e[o]=arguments[o];e.push(Date.now()),(t=i.logger).log.apply(t,["[ActionCable]"].concat(e))}}},s="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},c=function(t,n){if(!(t instanceof n))throw new TypeError("Cannot call a class as a function")},u=function(){function t(t,n){for(var e=0;e<n.length;e++){var o=n[e];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}return function(n,e,o){return e&&t(n.prototype,e),o&&t(n,o),n}}(),p=function(){return(new Date).getTime()},l=function(t){return(p()-t)/1e3},a=function(t,n,e){return Math.max(n,Math.min(e,t))},h=function(){function t(n){c(this,t),this.visibilityDidChange=this.visibilityDidChange.bind(this),this.connection=n,this.reconnectAttempts=0}return t.prototype.start=function(){this.isRunning()||(this.startedAt=p(),delete this.stoppedAt,this.startPolling(),addEventListener("visibilitychange",this.visibilityDidChange),r.log("ConnectionMonitor started. pollInterval = "+this.getPollInterval()+" ms"))},t.prototype.stop=function(){this.isRunning()&&(this.stoppedAt=p(),this.stopPolling(),removeEventListener("visibilitychange",this.visibilityDidChange),r.log("ConnectionMonitor stopped"))},t.prototype.isRunning=function(){return this.startedAt&&!this.stoppedAt},t.prototype.recordPing=function(){this.pingedAt=p()},t.prototype.recordConnect=function(){this.reconnectAttempts=0,this.recordPing(),delete this.disconnectedAt,r.log("ConnectionMonitor recorded connect")},t.prototype.recordDisconnect=function(){this.disconnectedAt=p(),r.log("ConnectionMonitor recorded disconnect")},t.prototype.startPolling=function(){this.stopPolling(),this.poll()},t.prototype.stopPolling=function(){clearTimeout(this.pollTimeout)},t.prototype.poll=function(){var t=this;this.pollTimeout=setTimeout((function(){t.reconnectIfStale(),t.poll()}),this.getPollInterval())},t.prototype.getPollInterval=function(){var t=this.constructor.pollInterval,n=t.min,e=t.max,o=t.multiplier*Math.log(this.reconnectAttempts+1);return Math.round(1e3*a(o,n,e))},t.prototype.reconnectIfStale=function(){this.connectionIsStale()&&(r.log("ConnectionMonitor detected stale connection. reconnectAttempts = "+this.reconnectAttempts+", pollInterval = "+this.getPollInterval()+" ms, time disconnected = "+l(this.disconnectedAt)+" s, stale threshold = "+this.constructor.staleThreshold+" s"),this.reconnectAttempts++,this.disconnectedRecently()?r.log("ConnectionMonitor skipping reopening recent disconnect"):(r.log("ConnectionMonitor reopening"),this.connection.reopen()))},t.prototype.connectionIsStale=function(){return l(this.pingedAt?this.pingedAt:this.startedAt)>this.constructor.staleThreshold},t.prototype.disconnectedRecently=function(){return this.disconnectedAt&&l(this.disconnectedAt)<this.constructor.staleThreshold},t.prototype.visibilityDidChange=function(){var t=this;"visible"===document.visibilityState&&setTimeout((function(){!t.connectionIsStale()&&t.connection.isOpen()||(r.log("ConnectionMonitor reopening stale connection on visibilitychange. visibilityState = "+document.visibilityState),t.connection.reopen())}),200)},t}();h.pollInterval={min:3,max:30,multiplier:5},h.staleThreshold=6;var f={message_types:{welcome:"welcome",disconnect:"disconnect",ping:"ping",confirmation:"confirm_subscription",rejection:"reject_subscription"},disconnect_reasons:{unauthorized:"unauthorized",invalid_request:"invalid_request",server_restart:"server_restart"},default_mount_path:"/cable",protocols:["actioncable-v1-json","actioncable-unsupported"]},d=f.message_types,g=f.protocols,b=g.slice(0,g.length-1),y=[].indexOf,m=function(){function t(n){c(this,t),this.open=this.open.bind(this),this.consumer=n,this.subscriptions=this.consumer.subscriptions,this.monitor=new h(this),this.disconnected=!0}return t.prototype.send=function(t){return!!this.isOpen()&&(this.webSocket.send(JSON.stringify(t)),!0)},t.prototype.open=function(){return this.isActive()?(r.log("Attempted to open WebSocket, but existing socket is "+this.getState()),!1):(r.log("Opening WebSocket, current state is "+this.getState()+", subprotocols: "+g),this.webSocket&&this.uninstallEventHandlers(),this.webSocket=new i.WebSocket(this.consumer.url,g),this.installEventHandlers(),this.monitor.start(),!0)},t.prototype.close=function(){if((arguments.length>0&&void 0!==arguments[0]?arguments[0]:{allowReconnect:!0}).allowReconnect||this.monitor.stop(),this.isActive())return this.webSocket.close()},t.prototype.reopen=function(){if(r.log("Reopening WebSocket, current state is "+this.getState()),!this.isActive())return this.open();try{return this.close()}catch(t){r.log("Failed to reopen WebSocket",t)}finally{r.log("Reopening WebSocket in "+this.constructor.reopenDelay+"ms"),setTimeout(this.open,this.constructor.reopenDelay)}},t.prototype.getProtocol=function(){if(this.webSocket)return this.webSocket.protocol},t.prototype.isOpen=function(){return this.isState("open")},t.prototype.isActive=function(){return this.isState("open","connecting")},t.prototype.isProtocolSupported=function(){return y.call(b,this.getProtocol())>=0},t.prototype.isState=function(){for(var t=arguments.length,n=Array(t),e=0;e<t;e++)n[e]=arguments[e];return y.call(n,this.getState())>=0},t.prototype.getState=function(){if(this.webSocket)for(var t in i.WebSocket)if(i.WebSocket[t]===this.webSocket.readyState)return t.toLowerCase();return null},t.prototype.installEventHandlers=function(){for(var t in this.events){var n=this.events[t].bind(this);this.webSocket["on"+t]=n}},t.prototype.uninstallEventHandlers=function(){for(var t in this.events)this.webSocket["on"+t]=function(){}},t}();m.reopenDelay=500,m.prototype.events={message:function(t){if(this.isProtocolSupported()){var n=JSON.parse(t.data),e=n.identifier,o=n.message,i=n.reason,s=n.reconnect;switch(n.type){case d.welcome:return this.monitor.recordConnect(),this.subscriptions.reload();case d.disconnect:return r.log("Disconnecting. Reason: "+i),this.close({allowReconnect:s});case d.ping:return this.monitor.recordPing();case d.confirmation:return this.subscriptions.confirmSubscription(e),this.subscriptions.notify(e,"connected");case d.rejection:return this.subscriptions.reject(e);default:return this.subscriptions.notify(e,"received",o)}}},open:function(){if(r.log("WebSocket onopen event, using '"+this.getProtocol()+"' subprotocol"),this.disconnected=!1,!this.isProtocolSupported())return r.log("Protocol is unsupported. Stopping monitor and disconnecting."),this.close({allowReconnect:!1})},close:function(){if(r.log("WebSocket onclose event"),!this.disconnected)return this.disconnected=!0,this.monitor.recordDisconnect(),this.subscriptions.notifyAll("disconnected",{willAttemptReconnect:this.monitor.isRunning()})},error:function(){r.log("WebSocket onerror event")}};var v=function(t,n){if(null!=n)for(var e in n){var o=n[e];t[e]=o}return t},S=function(){function t(n){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},o=arguments[2];c(this,t),this.consumer=n,this.identifier=JSON.stringify(e),v(this,o)}return t.prototype.perform=function(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return n.action=t,this.send(n)},t.prototype.send=function(t){return this.consumer.send({command:"message",identifier:this.identifier,data:JSON.stringify(t)})},t.prototype.unsubscribe=function(){return this.consumer.subscriptions.remove(this)},t}(),A=function(){function t(n){c(this,t),this.subscriptions=n,this.pendingSubscriptions=[]}return t.prototype.guarantee=function(t){-1==this.pendingSubscriptions.indexOf(t)?(r.log("SubscriptionGuarantor guaranteeing "+t.identifier),this.pendingSubscriptions.push(t)):r.log("SubscriptionGuarantor already guaranteeing "+t.identifier),this.startGuaranteeing()},t.prototype.forget=function(t){r.log("SubscriptionGuarantor forgetting "+t.identifier),this.pendingSubscriptions=this.pendingSubscriptions.filter((function(n){return n!==t}))},t.prototype.startGuaranteeing=function(){this.stopGuaranteeing(),this.retrySubscribing()},t.prototype.stopGuaranteeing=function(){clearTimeout(this.retryTimeout)},t.prototype.retrySubscribing=function(){var t=this;this.retryTimeout=setTimeout((function(){t.subscriptions&&"function"==typeof t.subscriptions.subscribe&&t.pendingSubscriptions.map((function(n){r.log("SubscriptionGuarantor resubscribing "+n.identifier),t.subscriptions.subscribe(n)}))}),500)},t}(),w=function(){function t(n){c(this,t),this.consumer=n,this.guarantor=new A(this),this.subscriptions=[]}return t.prototype.create=function(t,n){var e=t,o="object"===(void 0===e?"undefined":s(e))?e:{channel:e},i=new S(this.consumer,o,n);return this.add(i)},t.prototype.add=function(t){return this.subscriptions.push(t),this.consumer.ensureActiveConnection(),this.notify(t,"initialized"),this.subscribe(t),t},t.prototype.remove=function(t){return this.forget(t),this.findAll(t.identifier).length||this.sendCommand(t,"unsubscribe"),t},t.prototype.reject=function(t){var n=this;return this.findAll(t).map((function(t){return n.forget(t),n.notify(t,"rejected"),t}))},t.prototype.forget=function(t){return this.guarantor.forget(t),this.subscriptions=this.subscriptions.filter((function(n){return n!==t})),t},t.prototype.findAll=function(t){return this.subscriptions.filter((function(n){return n.identifier===t}))},t.prototype.reload=function(){var t=this;return this.subscriptions.map((function(n){return t.subscribe(n)}))},t.prototype.notifyAll=function(t){for(var n=this,e=arguments.length,o=Array(e>1?e-1:0),i=1;i<e;i++)o[i-1]=arguments[i];return this.subscriptions.map((function(e){return n.notify.apply(n,[e,t].concat(o))}))},t.prototype.notify=function(t,n){for(var e=arguments.length,o=Array(e>2?e-2:0),i=2;i<e;i++)o[i-2]=arguments[i];return("string"==typeof t?this.findAll(t):[t]).map((function(t){return"function"==typeof t[n]?t[n].apply(t,o):void 0}))},t.prototype.subscribe=function(t){this.sendCommand(t,"subscribe")&&this.guarantor.guarantee(t)},t.prototype.confirmSubscription=function(t){var n=this;r.log("Subscription confirmed "+t),this.findAll(t).map((function(t){return n.guarantor.forget(t)}))},t.prototype.sendCommand=function(t,n){var e=t.identifier;return this.consumer.send({command:n,identifier:e})},t}(),C=function(){function t(n){c(this,t),this._url=n,this.subscriptions=new w(this),this.connection=new m(this)}return t.prototype.send=function(t){return this.connection.send(t)},t.prototype.connect=function(){return this.connection.open()},t.prototype.disconnect=function(){return this.connection.close({allowReconnect:!1})},t.prototype.ensureActiveConnection=function(){if(!this.connection.isActive())return this.connection.open()},u(t,[{key:"url",get:function(){return n(this._url)}}]),t}();t.Connection=m,t.ConnectionMonitor=h,t.Consumer=C,t.INTERNAL=f,t.Subscription=S,t.Subscriptions=w,t.SubscriptionGuarantor=A,t.adapters=i,t.createWebSocketURL=n,t.logger=r,t.createConsumer=e,t.getConfig=o,Object.defineProperty(t,"__esModule",{value:!0})})),function(){this.App||(this.App={}),App.cable=ActionCable.createConsumer()}.call(this);